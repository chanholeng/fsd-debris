# 进程、线程之 Linux C 实现

- POSIX

# 进程

- 进程的概念、结构、内存映像、各种操作、守护进程
- 创建进程、退出进程，获取进程 ID，改变进程优先级

## 7.1 进程概述

> 本节要点：进程、线程、文件描述符、可执行程序和内存映像的区别。

- Linux 是一个多用户多任务的操作系统，进程时操作系统资源管理的最小单位。
- 进程的概念、进程的标识、Linux 进程的结构和状态
- 进程时动态的，是运行中的程序；程序是静态的，是一些保存在硬盘上的可执行代码。
- 线程在进程内部，它是比进程更小的能独立运行的基本单位，基本上不拥有系统资源。
- 进程在执行过程中有独立的内存单元，Linux 下可使用 ```ps```，```pstree``` 来查看当前系统进程。
- Linux 中，进程通过唯一的进程 ID 标识，是非负数，相关函数声明都在 unistd.h 中。
- Linux 中一个进程由 3 部分组成：代码段(程序可执行代码)、数据段(程序全局变量/常量/静态变量)和堆栈段(动态分配的内存变量)。
- Linux 中进程状态：运行状态 R、可中断等待状态 S、不可中断等待状态 D、僵死状态 Z、停止状态 T。
- Linux 进程控制包括创建进程、执行新锦成、退出进程以及改变进程优先级。
  - 对进程控制的主要系统调用：fork、exit、exec、wait、getpid、nice
- Linux 下 C 程序的生成分为 4 个阶段：预编译、编译、汇编、链接。
- 程序转化为进程通常需要：内核将程序读入内存并为其分配内存空间 -> 内核为该进程委培进程标识符 PID 和其他所需资源 -> 内核为该进程保存 PID 及相应的状态信息，把进程放到运行队列中等待系统调用程序调用。
- 进程的内存映像是指内核在内存中如何存放可执行程序文件。
  - Linux 下程序映像一般布局从内存低地址到高地址以此：代码段、数据段、未初始化数据段、堆、栈。

## 7.2 进程操作

> 本节要点：各种退出方式的比较、僵尸进程、孤儿进程、vfork 函数、fork 和 vfork 的区别。

- 进程的生命周期。创建进程有两种方式：操作系统创建和父进程创建。父进程创建的进程之间存在隶属关系。
- 系统启动时，操作系统会创建系统进程，承担管理和分配系统资源的任务。
- 系统调用 fork 是创建一个新进程的唯一方法，有两个返回值。父进程和子进程需要争夺 CPU。
- 一般来说，fork 之后哪个进程先执行是不确定的，取决于内核所使用的调度算法。
- 操作系统中进程享有同等执行权，除非某进程的优先级相对较高。
- 子进程与父进程有很多共同属性，也有很多不同属性。
- 守护进程独立于控制终端，运行在后台中，通常周期性地执行某种任务。
- 守护进程的启动方式有很多种——在 Linux 系统中启动时从启动脚本中启动、由作业规划进程启动、由用户终端执行。
- 创建守护进程程序时，有如下要点——让进程在后台执行，父进程退出；创建新对话期，摆脱父进程继承的影响；禁止进程重新打开终端；关闭不再需要的文件描述符；将当前目录更改为根目录；将文件创建时使用的屏蔽字设置为 0；处理 SIGCHLD 信号。
- 在 Linux 系统中进程退出的方法分为正常退出和异常退出两种，其中前者方法有三种，后者有两种。不管哪种退出方式，最终都会执行内核中的同一段代码，用来关闭进程所有已打开的文件描述符，释放x相应资源。
  - 正常退出方法：在 main 函数中执行 return；调用 exit 函数；调用 _exit 函数；
  - 异常退出方法：调用 about 函数；进程收到某个信号，而该信号使程序终止。
- 系统调用 exec 用于执行一个可执行程序以代替当前进程的执行映像。exec 调用并没有生成新的进程，调用后系统把代码段替换成新的程序代码，废弃原有的数据段和堆栈段并生成新的，唯一保留的是进程 ID。
- 为了便于灵活的使用 Shell，Linux 引入了环境变量的概念，包括用户主目录、终端类型、当前目录等。

# 线程

- 为何引入线程、如何创建线程、线程终止时的注意事项
- 如何建立线程的私有数据、多线程程序如何进行线程同步

## 8.1 线程和进程关系

> 本节要点：多线程对于对于多进程的优势

- 线程是计算机中独立运行的最小单位，是操作系统分配 CPU 时间的基本单位，运行时占用很少的系统资源。
- 在单核 CPU 主机上，各个线程是交替执行的；多核 CPU 上，多个线程可以同时运行。
- 线程也有其私有的数据信息，包括线程号、寄存器、堆栈、信号掩码、优先级、线程私有的存储空间

## 8.2 创建线程

> 本节要点：线程属性

- 子进程是通过拷贝父进程的地址空间来实现；线程与进程内的线程共享程序代码，一段代码同时被多个线程执行。
- 线程的创建通过函数 pthread_create 来完成，拥有参数：thread、attr、start_routine、arg。线程创建成功时函数返回 0，线程创建成功后，新创建的线程开始运行第 3 个参数所指向的函数，原来的线程继续执行。

## 8.3 线程终止

- Linux 下有两种方式可以使线程终止：通过 return 从线程函数返回；通过调用函数 pthread_exit() 使线程退出。

## 8.4 私有数据

- 多线程环境下，进程内的所有线程共享进程的数据空间。对于线程自己的全局变量，可以通过创建线程的私有数据来解决，私有数据采用了一键多值的技术。

## 8.5 线程同步

- Linux 系统提供了多种方式处理线程间的同步问题，其中最常用的有互斥锁、条件变量和异步信号。
- 互斥锁通过锁机制来实现进程间的同步。在同一时刻它通常只允许一个线程执行一个关键部分的代码。
- 条件变量是利用线程间共享的全局变量进行同步的一种机制。
- 在 Linux 操作系统中，线程是在内核外实现的，信号与任何线程都是异步的，可作为线程间同步手段。

## 8.6 出错处理

- 错误码是一些定义在 errno.h 中的宏。